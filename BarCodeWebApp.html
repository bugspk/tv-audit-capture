<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TV Audit â€“ Scan & Save as &lt;serial&gt;.jpg</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --pad:14px; --muted:#555; --btn:#2d6cdf; --ok:#0a0; --err:#d00; }
  body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; }
  .wrap { max-width:520px; margin:auto; padding:var(--pad); }
  h2 { margin:0 0 10px 0; }
  ol { color:#555; line-height:1.5; }
  label { font-weight:600; display:block; margin:12px 0 6px; }
  input[type="text"] { width:100%; padding:10px; font-size:18px; border:1px solid #ccc; border-radius:8px; }
  button { padding:10px 14px; font-size:16px; border:0; border-radius:10px; background:var(--btn); color:#fff; }
  button.secondary { background:#777; }
  button.ghost { background:#eee; color:#222; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  video { width:100%; border-radius:8px; background:#000; display:none; }
  #msg { margin-top:10px; font-size:14px; }
  .tips { margin-top:12px; color:var(--muted); font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <h2>TV Audit v0.4</h2>

  <p><b>How to use:</b></p>
  <ol>
    <li>Tap <b>Scan</b> to detect the TV barcode (or type serial manually).</li>
    <li>Tap <b>Take Photo</b> to capture the TV picture.</li>
    <li>Tap <b>Save as JPG</b> or <b>Save original file</b> to download it as <code>&lt;serial&gt;.jpg</code>.</li>
    <li><b>Tap Reset</b> before moving to the next TV.</li>
    <li>Upload saved photos to Google Drive <code>YYYY_MM</code> folder later.</li>
  </ol>

  <label>Serial</label>
  <div class="row">
    <input id="serial" type="text" placeholder="Scan or type serial...">
    <button id="scanBtn" type="button" class="ghost">Scan</button>
    <button id="stopBtn" type="button" class="secondary" style="display:none;">Stop</button>
  </div>
  <video id="video" playsinline muted></video>
  <div id="scanMsg" class="tips"></div>

  <label>Photo</label>
  <input id="photo" type="file" accept="image/*" capture="environment">
  <div class="row" style="margin-top:10px;">
    <button id="saveJpgBtn">Save as JPG (small)</button>
    <button id="saveOrigBtn" class="ghost">Save original file</button>
    <button id="resetBtn" class="secondary">Reset</button>
  </div>

  <div id="msg"></div>
</div>

<script>
/* ===== Elements ===== */
const serialEl = document.getElementById('serial');
const scanBtn  = document.getElementById('scanBtn');
const stopBtn  = document.getElementById('stopBtn');
const videoEl  = document.getElementById('video');
const scanMsg  = document.getElementById('scanMsg');
const photoInp = document.getElementById('photo');
const saveJpgBtn = document.getElementById('saveJpgBtn');
const saveOrigBtn= document.getElementById('saveOrigBtn');
const resetBtn = document.getElementById('resetBtn');
const msgEl    = document.getElementById('msg');

let stream=null, detector=null, running=false, loopId=null, canvas=null, ctx=null;

/* ===== Helpers ===== */
function show(ok,t){ msgEl.style.color=ok?'#0a0':'#d00'; msgEl.textContent=t||''; }
function safeSerial(s){ return (s||'').trim().replace(/\s+/g,'').replace(/[^A-Za-z0-9_-]/g,''); }

/* ===== Scanner ===== */
function startScan(){
  if(!('BarcodeDetector'in window)){alert('BarcodeDetector not supported');return;}
  try{detector=new BarcodeDetector({formats:['qr_code','code_128','code_39','ean_13','ean_8','itf','codabar']});}
  catch(e){alert('Scanner init failed: '+e);return;}
  navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false})
  .then(s=>{stream=s;videoEl.srcObject=s;return videoEl.play();})
  .then(()=>{videoEl.style.display='block';scanBtn.style.display='none';stopBtn.style.display='inline-block';scanMsg.textContent='Scanning...';running=true;loopScan();})
  .catch(e=>alert('Camera error: '+e.message));
}

function loopScan(){
  if(!running)return;
  if(!canvas){canvas=document.createElement('canvas');canvas.width=640;canvas.height=480;ctx=canvas.getContext('2d',{willReadFrequently:true});}
  try{ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);}catch(e){}
  detector.detect(canvas).then(results=>{
    if(results&&results.length){
      const code=results[0].rawValue||results[0].displayValue;
      if(code){serialEl.value=code.trim();stopScan(true);show(true,'Scanned: '+code);}
    }
    loopId=requestAnimationFrame(loopScan);
  }).catch(()=>{loopId=requestAnimationFrame(loopScan);});
}

function stopScan(hide){
  running=false;
  if(loopId)cancelAnimationFrame(loopId);
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
  if(hide){videoEl.style.display='none';scanMsg.textContent='';}
  scanBtn.style.display='inline-block';stopBtn.style.display='none';
}

/* ===== Save: Original ===== */
function saveOriginal(){
  const raw=serialEl.value.trim();
  const f=photoInp.files[0];
  if(!raw){alert('Enter serial first.');return;}
  if(!f){alert('Take/choose a photo.');return;}
  const safe=safeSerial(raw);
  const ext=(f.name.split('.').pop()||'jpg').toLowerCase();
  const outName=safe+'.'+ext;
  const a=document.createElement('a');
  const url=URL.createObjectURL(f);
  a.href=url;a.download=outName;document.body.appendChild(a);a.click();a.remove();
  try{URL.revokeObjectURL(url);}catch(_){}
  show(true,'Saved original as '+outName);
  resetAll();
}

/* ===== Save: JPG (compressed) ===== */
async function saveAsJpg(){
  const raw=serialEl.value.trim();
  const f=photoInp.files[0];
  if(!raw){alert('Enter serial first.');return;}
  if(!f){alert('Take/choose a photo.');return;}
  const safe=safeSerial(raw);
  const outName=safe+'.jpg';

  try{
    let img=await createImageBitmap(f);
    const MAX=800;
    let w=img.width,h=img.height;
    if(w>=h&&w>MAX){h=Math.round(h*(MAX/w));w=MAX;}
    else if(h>w&&h>MAX){w=Math.round(w*(MAX/h));h=MAX;}
    const cnv=document.createElement('canvas');
    cnv.width=w;cnv.height=h;
    const cctx=cnv.getContext('2d',{willReadFrequently:true});
    cctx.drawImage(img,0,0,w,h);
    const blob=await new Promise(r=>cnv.toBlob(r,'image/jpeg',0.85));
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=outName;document.body.appendChild(a);a.click();a.remove();
    try{URL.revokeObjectURL(url);}catch(_){}
    if(img.close)img.close();
    show(true,'Saved JPEG as '+outName);
    resetAll();
  }catch(e){
    show(false,'Memory issue. Saving original instead.');
    saveOriginal();
  }
}

/* ===== Reset ===== */
function resetAll(){
  stopScan(true);
  serialEl.value='';photoInp.value='';
  scanMsg.textContent='';show(true,'');
  setTimeout(()=>serialEl.focus(),200);
}

/* ===== Wire up ===== */
scanBtn.addEventListener('click',startScan);
stopBtn.addEventListener('click',()=>stopScan(true));
saveOrigBtn.addEventListener('click',saveOriginal);
saveJpgBtn.addEventListener('click',saveAsJpg);
resetBtn.addEventListener('click',resetAll);
setTimeout(()=>serialEl.focus(),400);
</script>
</body>
</html>
